# Протокол работы сетевого взаимодействия

## Описание протокола

Протокол реализует взаимодействие клиента и сервера для управления игровым процессом. Сообщения между клиентом и сервером передаются в формате JSON поверх TCP, при этом каждое сообщение имеет фиксированный заголовок, определяющий длину сообщения. 

### Формат сообщения

Каждое сообщение состоит из двух частей:
1. **Заголовок (Header)**:
   - Длина сообщения в байтах, упакованная в 4 байта (формат `!I`).
2. **Тело сообщения (Body)**:
   - JSON-объект с полями:
     - `type` — тип сообщения (строка).
     - `payload` — содержимое сообщения (объект, зависит от типа сообщения).

Пример JSON-формата тела сообщения:
```json
{
    "type": "gun_command",
    "payload": {
        "command": "move_left"
    }
}
```

### Типы сообщений и команды

Протокол поддерживает следующие типы сообщений:

| Тип сообщения      | Назначение                                   | Поля `payload`                                                   |
|---------------------|---------------------------------------------|------------------------------------------------------------------|
| `gun_command`       | Команды управления пушкой                   | `command` — строка (`move_left`, `move_right`, `rotate_up`, `rotate_down`) |
| `fire`              | Команда выстрела                           | Пустой объект `{}`                                               |
| `reset_game`        | Сброс состояния игры                       | Пустой объект `{}`                                               |
| `state_update`      | Обновление состояния игры                  | Объект с текущими состояниями кораблей, пушки и бомб             |

## Работа сервера

Сервер:
1. **Принимает команды от клиентов**:
   - Управление пушкой (`gun_command`).
   - Выстрел (`fire`).
   - Сброс игры (`reset_game`).
2. **Обновляет состояние игры**:
   - Генерация новых кораблей.
   - Обновление координат пушки и бомб.
   - Проверка столкновений и обработка взрывов.
3. **Рассылает обновления состояния игры всем клиентам**:
   - Формат: `state_update`.
   - Содержит текущие данные о позициях кораблей, пушки, активных бомбах.

### Формат состояния игры (`state_update`)

Объект состояния игры, передаваемый сервером:
```json
{
    "type": "state_update",
    "payload": {
        "ships": [
            {"x": 100, "y": 50, "health": 3},
            {"x": 200, "y": 80, "health": 2}
        ],
        "gun": {"x": 400, "y": 300, "angle": 90},
        "bombs": [
            {"x": 410, "y": 290, "speed": 5}
        ]
    }
}
```

## Работа клиента

Клиент:
1. Подключается к серверу по указанному хосту и порту.
2. Отправляет команды:
   - Управление пушкой (`send_gun_command`).
   - Выстрел (`send_fire_command`).
   - Сброс игры (`send_reset_command`).
3. Слушает сервер и получает обновления состояния игры (`state_update`).
4. Обновляет свое локальное состояние для отображения.

### Методы клиента

- **`send_gun_command(command: str)`**  
  Отправляет команду управления пушкой на сервер.  
  **Пример использования**:
  ```python
  client.send_gun_command("move_left")
  ```

- **`send_fire_command()`**  
  Отправляет команду выстрела.  
  **Пример использования**:
  ```python
  client.send_fire_command()
  ```

- **\`send_reset_command()\`**  
  Отправляет команду сброса игры.  
  **Пример использования**:
  ```python
  client.send_reset_command()
  ```

- **\`get_state()\`**  
  Возвращает локальное состояние клиента, обновляемое по сообщениям сервера.  
  **Пример использования**:
  ```python
  current_state = client.get_state()
  print(current_state["gun"])
  ```

### Пример работы клиента

```python
from client_handler import ClientHandler

client = ClientHandler()

# Команда движения пушки
client.send_gun_command("move_left")

# Команда выстрела
client.send_fire_command()

# Получение текущего состояния
state = client.get_state()
print(f"Пушка: {state['gun']}")
```

## Пример работы сервера

```python
from server_logic import GameLogic
from client_manager import ClientManager

# Инициализация логики игры
logic = GameLogic()

# Запуск сервера
manager = ClientManager(logic)
manager.start_listening()
```

## Конфигурация

Конфигурация (в `common/config.py`):
```python
HOST = "127.0.0.1"
PORT = 12345
```

## Требования

- Python 3.8+
- Библиотеки:
  - `socket`
  - `struct`
  - `json`
  - `threading`

## Запуск

1. Запустите сервер:
   ```bash
   python server_logic.py
   ```
2. Запустите клиента:
   ```bash
   python client_handler.py
   ```
